<!-- ================= GRID SECTION ================= -->
<section class="figma-grid">
  <div class="grid-wrapper">
    {% for product in collections.all.products limit:6 %}
    <div class="product-card" data-handle="{{ product.handle }}">
      <!-- IMAGE -->
      <div class="card-image">
        <img src="{{ product.featured_image | img_url: '600x' }}" alt="{{ product.title }}">
      </div>

      <!-- INFO -->
      <div class="card-info">
        <h3>{{ product.title }}</h3>
        <p class="price">{{ product.price | money }}</p>
        <!-- VARIANTS & ADD BUTTON -->
        <div class="variant-row">
          <select class="size-select">
            {% for variant in product.variants %}
              <option value="{{ variant.id }}">{{ variant.title }}</option>
            {% endfor %}
          </select>
          <button class="add-btn">ADD TO CART</button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</section>

<!-- ================= POPUP ================= -->
<div class="popup" style="display:none;">
  <div class="popup-box">
    <span class="close">&times;</span>
    <div class="popup-grid">
      <div class="popup-left">
        <img class="popup-img">
      </div>
      <div class="popup-right">
        <h2 class="popup-title"></h2>
        <p class="popup-price"></p>
        <div class="popup-desc"></div>
        <select class="popup-variants"></select>
        <button class="popup-add">ADD TO CART</button>
      </div>
    </div>
  </div>
</div>

<style>
/* GRID & CARD */
.figma-grid { padding:50px 30px; }
.grid-wrapper{ display:grid; grid-template-columns: repeat(3, 1fr); gap:25px; }
.product-card{ border:1px solid #eaeaea; background:#fff; cursor:pointer; transition:.25s; }
.product-card:hover{ transform:translateY(-4px); box-shadow:0 10px 20px rgba(0,0,0,.08); }
.card-image img{ width:100%; height:220px; object-fit:cover; }
.card-info{ padding:14px; text-align:center; }
.price{ font-weight:700; margin:6px 0 12px; }
.variant-row{ display:flex; gap:8px; }
.size-select{ flex:1; padding:8px; border:1px solid #ddd; }
.add-btn{ background:#000; color:#fff; border:none; padding:10px 12px; font-weight:600; cursor:pointer; transition:.2s; }
.add-btn:hover{ background:#333; }

/* POPUP */
.popup{ position:fixed; inset:0; background:rgba(0,0,0,.65); display:flex; justify-content:center; align-items:center; z-index:9999; }
.popup-box{ background:#fff; width:90%; max-width:850px; border-radius:10px; padding:25px; box-shadow:0 25px 50px rgba(0,0,0,.25); position:relative; }
.popup-grid{ display:grid; grid-template-columns:1fr 1fr; gap:30px; }
.popup-left img{ width:100%; height:350px; object-fit:cover; border-radius:8px; }
.popup-right{ display:flex; flex-direction:column; gap:12px; }
.popup-title{ font-size:22px; font-weight:700; }
.popup-price{ font-size:20px; font-weight:700; }
.popup-variants{ padding:10px; border:1px solid #ddd; }
.popup-add{ background:#000; color:#fff; padding:12px; border:none; font-weight:700; cursor:pointer; }
.popup-add:hover{ background:#333; }
.close{ position:absolute; top:10px; right:15px; font-size:26px; cursor:pointer; }

@media(max-width:480px){
  .grid-wrapper{ grid-template-columns: repeat(2, 1fr); gap:5px; padding:0; }
  .popup-box{ width:85%; padding:15px; }
  .popup-grid{ grid-template-columns:1fr; gap:15px; }
  .popup-left img{ max-height:200px; }
}
@media(max-width:360px){ .grid-wrapper{ grid-template-columns:1fr; gap:0; } }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const popup = document.querySelector(".popup");
  const close = document.querySelector(".close");
  const popupImg = document.querySelector(".popup-img");
  const popupTitle = document.querySelector(".popup-title");
  const popupPrice = document.querySelector(".popup-price");
  const popupDesc = document.querySelector(".popup-desc");
  const popupVariants = document.querySelector(".popup-variants");
  const popupAdd = document.querySelector(".popup-add");

  // ================= HELPER: ADD TO CART =================
  function addToCart(id, qty){
    fetch('/cart/add.js',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({id:id, quantity:qty})
    })
    .then(r=>r.json())
    .then(()=> alert("Added to cart"))
    .catch(err=> console.error(err));
  }

  // ================= SPECIAL VARIANT LOGIC =================
  function checkSpecialVariantAndAdd(product){
    const selectedVariant = product.variants.find(v=>v.id==product.selectedVariantId);
    if(selectedVariant && selectedVariant.title.includes("Black") && selectedVariant.title.includes("Medium")){
      fetch('/products/soft-winter-jacket.js')
        .then(res=>res.json())
        .then(swj=>{
          addToCart(swj.variants[0].id,1);
        });
    }
  }

  // ================= GRID CARD CLICK =================
  document.querySelectorAll(".product-card").forEach(card => {
    // Card click opens popup
    card.addEventListener("click", e => {
      if(e.target.classList.contains("add-btn")) return; // ignore add button
      const handle = card.dataset.handle;
      fetch(`/products/${handle}.js`)
        .then(res=>res.json())
        .then(product=>{
          popup.style.display="flex";
          popupImg.src = product.images[0];
          popupTitle.textContent = product.title;
          popupPrice.textContent = (product.price/100).toFixed(2);
          popupDesc.innerHTML = product.description;
          popupVariants.innerHTML="";
          product.variants.forEach(v=>{
            const o = document.createElement("option");
            o.value = v.id;
            o.textContent = v.title;
            popupVariants.appendChild(o);
          });

          // Popup Add to Cart
          popupAdd.onclick = () => {
            product.selectedVariantId = popupVariants.value;
            addToCart(popupVariants.value,1);
            checkSpecialVariantAndAdd(product);
          };
        });
    });

    // Card Add button
    const btn = card.querySelector(".add-btn");
    btn.addEventListener("click", e=>{
      e.stopPropagation();
      const variantId = card.querySelector(".size-select").value;
      const handle = card.dataset.handle;
      fetch(`/products/${handle}.js`)
        .then(res=>res.json())
        .then(product=>{
          product.selectedVariantId = variantId;
          addToCart(variantId,1);
          checkSpecialVariantAndAdd(product);
        });
    });
  });

  // ================= CLOSE POPUP =================
  close.addEventListener("click", ()=> popup.style.display="none");
});
</script>
